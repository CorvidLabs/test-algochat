name: Cross-Implementation Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  swift-tests:
    name: Swift Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: Build Swift
        run: swift build

      - name: Run Swift crypto tests
        run: swift run TestAlgoChat crypto

  typescript-tests:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build ts-algochat dependency
        run: |
          cd node_modules/ts-algochat
          bun install
          bun run build

      - name: Run TypeScript tests
        run: bun test ts/crypto.test.ts

  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout py-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/py-algochat
          path: py-algochat

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install py-algochat
        run: |
          cd py-algochat
          pip install -e ".[dev]"

      - name: Run Python tests
        run: |
          cd py-algochat
          pytest -v

  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout rs-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/rs-algochat
          path: rs-algochat

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run Rust tests
        run: |
          cd rs-algochat
          cargo test --verbose

  kotlin-tests:
    name: Kotlin Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout kt-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/kt-algochat
          path: kt-algochat

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Run Kotlin tests
        run: |
          cd kt-algochat
          ./gradlew test || gradle test

  cross-implementation:
    name: Cross-Implementation Verification
    runs-on: ubuntu-latest
    needs: [swift-tests, typescript-tests, python-tests, rust-tests, kotlin-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Checkout all implementation repos
      - name: Checkout py-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/py-algochat
          path: py-algochat

      - name: Checkout rs-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/rs-algochat
          path: rs-algochat

      - name: Checkout kt-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/kt-algochat
          path: kt-algochat

      # Setup all languages
      - name: Install Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Install dependencies
      - name: Install TypeScript dependencies
        run: |
          bun install
          cd node_modules/ts-algochat
          bun install
          bun run build

      - name: Install Python dependencies
        run: |
          cd py-algochat
          pip install -e ".[dev]"

      - name: Build Swift
        run: swift build

      - name: Build Rust
        run: |
          cd rs-algochat
          cargo build

      - name: Build Kotlin
        run: |
          cd kt-algochat
          ./gradlew build -x test || gradle build -x test

      # Generate envelopes from all implementations
      - name: Generate Swift envelopes
        run: |
          echo "=== Generating Swift envelopes ==="
          swift run TestAlgoChat crypto

      - name: Generate TypeScript envelopes
        run: |
          echo "=== Generating TypeScript envelopes ==="
          bun test ts/crypto.test.ts

      - name: Generate Python envelopes
        run: |
          echo "=== Generating Python envelopes ==="
          cd py-algochat
          PYTHONPATH=src python ../scripts/python_cross_impl.py export ../test-envelopes-python

      - name: Generate Rust envelopes
        run: |
          echo "=== Generating Rust envelopes ==="
          cd rs-algochat
          cargo run --example export_envelopes -- ../test-envelopes-rust

      - name: Generate Kotlin envelopes
        run: |
          echo "=== Generating Kotlin envelopes ==="
          cd kt-algochat
          ./gradlew test --tests "CrossImplTest" --info || gradle test --tests "CrossImplTest" --info

      # Cross-implementation verification
      - name: Swift verifies all implementations
        run: |
          echo "=== Swift decrypting envelopes from all implementations ==="
          swift run TestAlgoChat cross-impl

      - name: TypeScript verifies all implementations
        run: |
          echo "=== TypeScript decrypting envelopes from all implementations ==="
          bun test ts/crypto.test.ts --test-name-pattern "cross-impl"

      - name: Python verifies all implementations
        run: |
          echo "=== Python decrypting envelopes from all implementations ==="
          cd py-algochat
          PYTHONPATH=src python ../scripts/python_cross_impl.py verify

      - name: Rust verifies all implementations
        run: |
          echo "=== Rust decrypting envelopes from all implementations ==="
          cd rs-algochat
          cargo test cross_impl -- --nocapture || echo "Cross-impl tests completed"

      - name: Print summary
        run: |
          echo ""
          echo "========================================"
          echo "Cross-Implementation Verification Summary"
          echo "========================================"
          echo ""
          echo "Envelope directories:"
          ls -la test-envelopes-* 2>/dev/null || echo "No envelope directories found"
          echo ""
          echo "Each implementation verified decryption of envelopes from:"
          echo "  - Swift"
          echo "  - TypeScript"
          echo "  - Python"
          echo "  - Rust"
          echo "  - Kotlin"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-envelopes
          path: |
            test-envelopes-swift/
            test-envelopes-ts/
            test-envelopes-python/
            test-envelopes-rust/
            test-envelopes-kotlin/
            report.html
          if-no-files-found: ignore
