name: Cross-Implementation Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  crypto-tests:
    name: Crypto Compatibility
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install TypeScript dependencies
        run: bun install

      - name: Build ts-algochat dependency
        run: |
          cd node_modules/ts-algochat
          bun install
          bun run build

      - name: Build Swift
        run: swift build

      - name: Run Swift crypto tests
        run: swift run TestAlgoChat crypto

      - name: Run TypeScript crypto tests
        run: bun test ts/crypto.test.ts

      - name: Verify cross-implementation decryption
        run: |
          echo "=== Cross-Implementation Verification ==="
          swift run TestAlgoChat crypto
          bun test ts/crypto.test.ts --test-name-pattern "decrypt Swift"
          echo "âœ“ TypeScript successfully decrypted Swift envelope"

      - name: Generate HTML report
        run: bun scripts/generate-report.ts

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: report.html
