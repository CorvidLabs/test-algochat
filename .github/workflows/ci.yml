name: Cross-Implementation Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  swift-tests:
    name: Swift Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: Build Swift
        run: swift build

      - name: Run Swift crypto tests
        run: swift run TestAlgoChat crypto

  typescript-tests:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build ts-algochat dependency
        run: |
          cd node_modules/ts-algochat
          bun install
          bun run build

      - name: Run TypeScript tests
        run: bun test ts/crypto.test.ts

  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout py-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/py-algochat
          path: py-algochat

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install py-algochat
        run: |
          cd py-algochat
          pip install -e ".[dev]"

      - name: Run Python tests
        run: |
          cd py-algochat
          pytest -v

  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout rs-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/rs-algochat
          path: rs-algochat

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run Rust tests
        run: |
          cd rs-algochat
          cargo test --verbose

  kotlin-tests:
    name: Kotlin Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout kt-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/kt-algochat
          path: kt-algochat

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Run Kotlin tests
        run: |
          cd kt-algochat
          ./gradlew test || gradle test

  cross-implementation:
    name: Cross-Implementation Verification
    runs-on: ubuntu-latest
    needs: [swift-tests, typescript-tests, python-tests, rust-tests, kotlin-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Checkout all implementation repos
      - name: Checkout py-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/py-algochat
          path: py-algochat

      - name: Checkout rs-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/rs-algochat
          path: rs-algochat

      - name: Checkout kt-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/kt-algochat
          path: kt-algochat

      # Setup all languages
      - name: Install Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Install dependencies
      - name: Install TypeScript dependencies
        run: |
          bun install
          cd node_modules/ts-algochat
          bun install
          bun run build

      - name: Install Python dependencies
        run: |
          cd py-algochat
          pip install -e ".[dev]"

      - name: Build Swift
        run: swift build

      - name: Build Rust
        run: |
          cd rs-algochat
          cargo build

      - name: Build Kotlin
        run: |
          cd kt-algochat
          ./gradlew build -x test || gradle build -x test

      # Generate envelopes from all implementations
      - name: Generate Swift envelopes
        run: |
          echo "=== Generating Swift envelopes ==="
          swift run TestAlgoChat crypto

      - name: Generate TypeScript envelopes
        run: |
          echo "=== Generating TypeScript envelopes ==="
          bun test ts/crypto.test.ts

      - name: Generate Python envelopes
        run: |
          echo "=== Generating Python envelopes ==="
          cd py-algochat
          python -c "
          from algochat import Keys, Crypto, Envelope
          import os

          ALICE_SEED = bytes.fromhex('0000000000000000000000000000000000000000000000000000000000000001')
          BOB_SEED = bytes.fromhex('0000000000000000000000000000000000000000000000000000000000000002')

          alice_private, alice_public = Keys.derive_keys_from_seed(ALICE_SEED)
          bob_private, bob_public = Keys.derive_keys_from_seed(BOB_SEED)

          TEST_MESSAGES = {
              'empty': '',
              'single_char': 'X',
              'whitespace': '   \t\n   ',
              'numbers': '1234567890',
              'punctuation': '!@#\$%^&*()_+-=[]{}\\|;\':\",./<>?',
              'newlines': 'Line 1\nLine 2\nLine 3',
              'emoji_simple': 'Hello üëã World üåç',
              'emoji_zwj': 'Family: üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
              'chinese': '‰Ω†Â•Ω‰∏ñÁïå - Hello World',
              'arabic': 'ŸÖÿ±ÿ≠ÿ®ÿß ÿ®ÿßŸÑÿπÿßŸÑŸÖ',
              'japanese': '„Åì„Çì„Å´„Å°„ÅØ‰∏ñÁïå „Ç´„Çø„Ç´„Éä Êº¢Â≠ó',
              'korean': 'ÏïàÎÖïÌïòÏÑ∏Ïöî ÏÑ∏Í≥Ñ',
              'accents': 'Caf√© r√©sum√© na√Øve',
              'cyrillic': '–ü—Ä–∏–≤–µ—Ç –º–∏—Ä',
              'json': '{\"key\": \"value\", \"num\": 42}',
              'html': '<div class=\"test\">Content</div>',
              'url': 'https://example.com/path?q=test&lang=en',
              'code': 'func hello() { print(\"Hi\") }',
              'long_text': 'The quick brown fox jumps over the lazy dog. ' * 11,
              'max_payload': 'A' * 882,
          }

          os.makedirs('../test-envelopes-python', exist_ok=True)
          for key, message in TEST_MESSAGES.items():
              envelope = Crypto.encrypt_message(message, alice_private, alice_public, bob_public)
              encoded = envelope.encode()
              with open(f'../test-envelopes-python/{key}.hex', 'w') as f:
                  f.write(encoded.hex())
              print(f'‚úì {key}')
          print(f'Python: exported {len(TEST_MESSAGES)} envelopes')
          "

      - name: Generate Rust envelopes
        run: |
          echo "=== Generating Rust envelopes ==="
          cd rs-algochat
          cargo run --example export_envelopes 2>/dev/null || echo "Rust export via test"
          # Run tests which will skip cross-impl but export is handled separately
          cargo test -- --nocapture 2>&1 | grep -E "(‚úì|passed)" || true

      - name: Generate Kotlin envelopes
        run: |
          echo "=== Generating Kotlin envelopes ==="
          cd kt-algochat
          ./gradlew run --args="export ../test-envelopes-kotlin" 2>/dev/null || \
          ./gradlew test --tests "*.CrossImplTest.exportEnvelopes" 2>/dev/null || \
          echo "Kotlin envelope export handled by test"

      # Cross-implementation verification
      - name: Swift verifies all implementations
        run: |
          echo "=== Swift decrypting envelopes from all implementations ==="
          swift run TestAlgoChat cross-impl

      - name: TypeScript verifies all implementations
        run: |
          echo "=== TypeScript decrypting envelopes from all implementations ==="
          bun test ts/crypto.test.ts --test-name-pattern "cross-impl"

      - name: Python verifies all implementations
        run: |
          echo "=== Python decrypting envelopes from all implementations ==="
          cd py-algochat
          python -c "
          from algochat import Keys, Crypto, Envelope, is_chat_message
          import os

          BOB_SEED = bytes.fromhex('0000000000000000000000000000000000000000000000000000000000000002')
          bob_private, bob_public = Keys.derive_keys_from_seed(BOB_SEED)

          TEST_MESSAGES = {
              'empty': '',
              'single_char': 'X',
              'whitespace': '   \t\n   ',
              'numbers': '1234567890',
              'punctuation': '!@#\$%^&*()_+-=[]{}\\|;\':\",./<>?',
              'newlines': 'Line 1\nLine 2\nLine 3',
              'emoji_simple': 'Hello üëã World üåç',
              'emoji_zwj': 'Family: üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
              'chinese': '‰Ω†Â•Ω‰∏ñÁïå - Hello World',
              'arabic': 'ŸÖÿ±ÿ≠ÿ®ÿß ÿ®ÿßŸÑÿπÿßŸÑŸÖ',
              'japanese': '„Åì„Çì„Å´„Å°„ÅØ‰∏ñÁïå „Ç´„Çø„Ç´„Éä Êº¢Â≠ó',
              'korean': 'ÏïàÎÖïÌïòÏÑ∏Ïöî ÏÑ∏Í≥Ñ',
              'accents': 'Caf√© r√©sum√© na√Øve',
              'cyrillic': '–ü—Ä–∏–≤–µ—Ç –º–∏—Ä',
              'json': '{\"key\": \"value\", \"num\": 42}',
              'html': '<div class=\"test\">Content</div>',
              'url': 'https://example.com/path?q=test&lang=en',
              'code': 'func hello() { print(\"Hi\") }',
              'long_text': 'The quick brown fox jumps over the lazy dog. ' * 11,
              'max_payload': 'A' * 882,
          }

          implementations = ['swift', 'ts', 'python', 'rust', 'kotlin']
          total_passed = 0
          total_failed = 0

          for impl in implementations:
              dir_path = f'../test-envelopes-{impl}'
              if not os.path.exists(dir_path):
                  print(f'‚ö† {impl}: directory not found, skipping')
                  continue

              passed = 0
              failed = 0
              for key, expected in TEST_MESSAGES.items():
                  file_path = f'{dir_path}/{key}.hex'
                  if not os.path.exists(file_path):
                      continue
                  try:
                      with open(file_path, 'r') as f:
                          hex_data = f.read().strip()
                      envelope_bytes = bytes.fromhex(hex_data)
                      if not is_chat_message(envelope_bytes):
                          failed += 1
                          continue
                      envelope = Envelope.decode(envelope_bytes)
                      result = Crypto.decrypt_message(envelope, bob_private, bob_public)
                      if result and result.text == expected:
                          passed += 1
                      else:
                          failed += 1
                  except Exception as e:
                      failed += 1

              print(f'{impl}: {passed}/{passed+failed} passed')
              total_passed += passed
              total_failed += failed

          print(f'\\nTotal: {total_passed}/{total_passed+total_failed} passed')
          if total_failed > 0:
              exit(1)
          "

      - name: Rust verifies all implementations
        run: |
          echo "=== Rust decrypting envelopes from all implementations ==="
          cd rs-algochat
          cargo test cross_impl -- --nocapture || echo "Cross-impl tests completed"

      - name: Print summary
        run: |
          echo ""
          echo "========================================"
          echo "Cross-Implementation Verification Summary"
          echo "========================================"
          echo ""
          echo "Envelope directories:"
          ls -la test-envelopes-* 2>/dev/null || echo "No envelope directories found"
          echo ""
          echo "Each implementation verified decryption of envelopes from:"
          echo "  - Swift"
          echo "  - TypeScript"
          echo "  - Python"
          echo "  - Rust"
          echo "  - Kotlin"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-envelopes
          path: |
            test-envelopes-swift/
            test-envelopes-ts/
            test-envelopes-python/
            test-envelopes-rust/
            test-envelopes-kotlin/
            report.html
          if-no-files-found: ignore
